{% extends 'calculator/base.html' %}

{% block content %}
<div class="calculator-wrapper">
    <div class="calculator-container">
        <div class="calculator-header">
            <h1>Calculator</h1>
            <button 
                class="history-toggle"
                hx-get="{% url 'calculator:history' %}"
                hx-target="#history-panel"
                hx-swap="innerHTML"
                title="View History">
                ðŸ“Š
            </button>
        </div>
        
        <!-- Display Area -->
        <div id="display-container" class="display-container">
            <div class="expression" id="expression"></div>
            <div class="display" id="display">0</div>
        </div>
        
        <!-- Calculator Buttons -->
        <form id="calculator-form" hx-post="{% url 'calculator:calculate' %}" hx-target="#display-container" hx-swap="innerHTML">
            {% csrf_token %}
            <input type="hidden" name="expression" id="expression-input" value="">
            
            <div class="calculator-grid">
                <!-- Row 1 -->
                <button type="button" class="btn btn-function" onclick="clearAll()">AC</button>
                <button type="button" class="btn btn-function" onclick="deleteLast()">DEL</button>
                <button type="button" class="btn btn-operator" onclick="appendValue('%')">%</button>
                <button type="button" class="btn btn-operator" onclick="appendValue('Ã·')">Ã·</button>
                
                <!-- Row 2 -->
                <button type="button" class="btn btn-number" onclick="appendValue('7')">7</button>
                <button type="button" class="btn btn-number" onclick="appendValue('8')">8</button>
                <button type="button" class="btn btn-number" onclick="appendValue('9')">9</button>
                <button type="button" class="btn btn-operator" onclick="appendValue('Ã—')">Ã—</button>
                
                <!-- Row 3 -->
                <button type="button" class="btn btn-number" onclick="appendValue('4')">4</button>
                <button type="button" class="btn btn-number" onclick="appendValue('5')">5</button>
                <button type="button" class="btn btn-number" onclick="appendValue('6')">6</button>
                <button type="button" class="btn btn-operator" onclick="appendValue('-')">-</button>
                
                <!-- Row 4 -->
                <button type="button" class="btn btn-number" onclick="appendValue('1')">1</button>
                <button type="button" class="btn btn-number" onclick="appendValue('2')">2</button>
                <button type="button" class="btn btn-number" onclick="appendValue('3')">3</button>
                <button type="button" class="btn btn-operator" onclick="appendValue('+')">+</button>
                
                <!-- Row 5 -->
                <button type="button" class="btn btn-number btn-zero" onclick="appendValue('0')">0</button>
                <button type="button" class="btn btn-number" onclick="appendValue('.')">.</button>
                <button type="button" class="btn btn-equals" onclick="calculate()">=</button>
            </div>
        </form>
    </div>
    
    <!-- History Panel -->
    <div class="history-container">
        <div class="history-header">
            <h2>History</h2>
            <button 
                class="btn-clear-history"
                hx-post="{% url 'calculator:clear_history' %}"
                hx-target="#history-panel"
                hx-swap="innerHTML"
                hx-confirm="Clear all history?">
                Clear
            </button>
        </div>
        <div id="history-panel">
            {% include 'calculator/history.html' %}
        </div>
    </div>
</div>

<script>
    let currentExpression = '';
    let displayValue = '0';
    
    function appendValue(value) {
        if (displayValue === '0' && value !== '.') {
            displayValue = value;
        } else {
            displayValue += value;
        }
        currentExpression += value;
        updateDisplay();
    }
    
    function deleteLast() {
        if (currentExpression.length > 0) {
            currentExpression = currentExpression.slice(0, -1);
            displayValue = currentExpression || '0';
            updateDisplay();
        }
    }
    
    function clearAll() {
        currentExpression = '';
        displayValue = '0';
        updateDisplay();
    }
    
    function updateDisplay() {
        document.getElementById('display').textContent = displayValue;
        document.getElementById('expression').textContent = currentExpression;
        document.getElementById('expression-input').value = currentExpression;
    }
    
    function calculate() {
        if (currentExpression) {
            htmx.trigger('#calculator-form', 'submit');
        }
    }
    
    // Keyboard support
    document.addEventListener('keydown', function(event) {
        const key = event.key;
        
        if (key >= '0' && key <= '9') {
            appendValue(key);
        } else if (key === '.') {
            appendValue('.');
        } else if (key === '+') {
            appendValue('+');
        } else if (key === '-') {
            appendValue('-');
        } else if (key === '*') {
            appendValue('Ã—');
        } else if (key === '/') {
            event.preventDefault();
            appendValue('Ã·');
        } else if (key === '%') {
            appendValue('%');
        } else if (key === 'Enter' || key === '=') {
            event.preventDefault();
            calculate();
        } else if (key === 'Escape') {
            clearAll();
        } else if (key === 'Backspace') {
            event.preventDefault();
            deleteLast();
        }
    });
    
    // Handle HTMX response
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'display-container') {
            // Reset after calculation
            const resultElement = document.getElementById('display');
            if (resultElement) {
                displayValue = resultElement.textContent;
                currentExpression = displayValue === 'Error' ? '' : displayValue;
                
                // Refresh history
                htmx.trigger('.history-toggle', 'click');
            }
        }
    });
</script>
{% endblock %}
